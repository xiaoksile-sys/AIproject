# 飞书多维表格第三方应用集成系统

## 项目介绍

本项目是一个用于接收、处理和存储飞书多维表格数据的第三方应用服务器。通过该系统，您可以轻松实现与飞书多维表格的数据集成，支持数据的接收、验证、处理和持久化存储。

## 功能特性

### 核心功能
- ✅ **飞书多维表格数据接收**：提供标准的API接口接收飞书多维表格推送的数据
- ✅ **数据验证与签名验证**：支持验证请求签名，确保数据来源安全可靠
- ✅ **灵活的数据处理**：支持处理不同类型的数据（字符串、数字、布尔值、数组、对象等）
- ✅ **数据持久化存储**：将处理后的数据保存到本地文件系统
- ✅ **数据查询接口**：提供API接口查询已处理的数据和系统统计信息
- ✅ **健康检查**：支持飞书平台验证的健康检查接口

### 接口特性
- **统一响应格式**：所有接口返回符合飞书规范的响应格式
- **详细日志记录**：记录请求头、处理过程和错误信息
- **错误处理**：完善的错误捕获和处理机制
- **支持多种动作类型**：create、update、delete等

## 技术栈

- **Node.js**：JavaScript运行环境
- **Express.js**：Web框架
- **文件系统**：用于数据持久化存储

## 快速开始

### 1. 安装依赖

```bash
# 进入项目目录
cd 记账网页3

# 安装依赖包
npm install
```

### 2. 启动服务器

```bash
npm start
```

服务器将在端口3000启动，默认监听地址为`http://localhost:3000`

## API文档

### 1. 数据接收接口

**URL**: `/api/receive-data`
**方法**: `POST`
**用途**: 接收飞书多维表格推送的数据

**请求头要求**:
- `x-lark-request-timestamp`：时间戳
- `x-lark-request-nonce`：随机字符串
- `x-lark-signature`：签名信息
- `Content-Type`: `application/json`

**请求体示例**:
```json
{
  "records": [
    {
      "id": "rec_123",
      "fields": {
        "日期": "2023-11-22",
        "金额": 100.5,
        "分类": "餐饮",
        "备注": "午餐"
      },
      "action": "create",
      "table_id": "tbl_123456"
    }
  ]
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "processed_count": 1,
    "timestamp": 1763776625
  }
}
```

### 2. 健康检查接口

**URL**: `/` 或 `/api/ping`
**方法**: `GET`
**用途**: 用于飞书平台验证应用是否正常运行

**响应示例**:
```json
{
  "message": "飞书多维表格第三方应用服务器运行中",
  "status": "healthy",
  "timestamp": 1763776625
}
```

### 3. 数据查询接口

**URL**: `/api/data`
**方法**: `GET`
**用途**: 获取系统处理的数据统计信息

**响应示例**:
```json
{
  "total_processed": 5,
  "last_received": "2025-11-22T01:56:46.551Z",
  "stats": {
    "create": 3,
    "update": 2
  }
}
```

### 4. 记录查询接口

**URL**: `/api/records`
**方法**: `GET`
**用途**: 查询已处理的具体记录数据

**响应示例**:
```json
{
  "records": [
    {
      "id": "rec_123",
      "fields": {
        "日期": "2023-11-22T00:00:00.000Z",
        "金额": 100.5,
        "分类": "餐饮",
        "备注": "午餐"
      },
      "action": "create",
      "created_at": "2025-11-22T01:56:46.551Z",
      "metadata": {
        "source": "feishu",
        "table_id": "tbl_123456"
      }
    }
  ]
}
```

### 5. 统计信息接口

**URL**: `/api/stats`
**方法**: `GET`
**用途**: 获取系统运行的详细统计信息

**响应示例**:
```json
{
  "server_time": "2025-11-22T01:56:46.551Z",
  "memory_data": {
    "total_records": 5,
    "total_processed": 5
  },
  "storage_data": {
    "storage_path": "./data",
    "last_saved": "2025-11-22T01:56:46.551Z"
  },
  "uptime": "5m 30s"
}
```

### 6. 数据清除接口

**URL**: `/api/clear-data`
**方法**: `DELETE`
**用途**: 清除所有存储的数据（测试和维护用）

**响应示例**:
```json
{
  "code": 0,
  "message": "数据已成功清除",
  "data": {
    "cleared_count": 5,
    "timestamp": 1763776625
  }
}
```

## 与飞书多维表格集成

### 1. 在飞书多维表格中配置

1. 打开您的飞书多维表格
2. 点击右上角「更多」按钮
3. 选择「自定义同步应用」
4. 填写以下信息：
   - **应用服务地址**: `https://your-server-domain/api/receive-data`
     > 注意：您需要将服务器部署到公网可访问的地址
   - **Verification token**: 建议设置一个安全的验证令牌

### 2. 配置服务器

在服务器代码中设置相同的验证令牌，确保签名验证能够通过：

```javascript
// 在server.js中设置验证令牌
const VERIFICATION_TOKEN = 'your_verification_token_here';
```

## 数据处理说明

### 支持的数据类型
- **字符串**: 直接处理
- **数字**: 整数和浮点数
- **布尔值**: true/false
- **日期**: 自动转换为ISO格式
- **数组**: 支持标签等数组类型字段
- **对象**: 支持负责人等对象类型字段

### 数据转换规则
- 日期字符串会自动转换为ISO格式的日期对象
- 对于缺少ID的记录，系统会自动生成唯一ID
- 所有记录都会添加处理时间戳和元数据

## 测试方法

本项目包含测试脚本，您可以使用这些脚本模拟飞书多维表格发送数据：

### 基本测试

```bash
node test/test-script.js
```

### 复杂数据类型测试

```bash
node test/complex-test-script.js
```

## 常见问题

### 1. 服务器无法启动
- 检查端口3000是否被占用
- 检查依赖包是否正确安装

### 2. 飞书多维表格无法连接到服务器
- 确保服务器已部署到公网可访问的地址
- 检查防火墙设置，确保端口开放
- 验证应用服务地址配置正确

### 3. 数据验证失败
- 确保Verification token配置一致
- 检查请求头格式是否正确

## 部署建议

### 开发环境
- 使用 `npm start` 直接启动

### 生产环境
- 建议使用PM2等进程管理工具
- 配置HTTPS安全连接
- 定期备份数据存储目录

## 文件结构

```
记账网页3/
├── server.js            # 主服务器文件
├── utils/               # 工具函数目录
│   ├── storage.js       # 数据存储工具
│   └── dataProcessor.js # 数据处理工具
├── data/                # 数据存储目录
├── test/                # 测试脚本
│   ├── test-script.js          # 基本测试脚本
│   ├── test-data.json          # 测试数据
│   ├── complex-test-script.js  # 复杂数据测试脚本
│   └── complex-test-data.json  # 复杂测试数据
├── package.json         # 项目配置文件
└── README.md            # 使用说明文档
```

## 安全注意事项

1. 请务必设置强验证令牌，防止未授权访问
2. 在生产环境中使用HTTPS协议
3. 定期清理日志文件，避免敏感信息泄露
4. 考虑添加IP白名单限制访问来源

## License

MIT

## 支持与维护

如有问题或需要帮助，请根据实际情况联系相关技术支持。